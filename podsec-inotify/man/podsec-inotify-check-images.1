.\" generated with Ronn/v0.7.3
.\" http://github.com/rtomayko/ronn/tree/0.7.3
.
.TH "PODSEC\-INOTIFY\-CHECK\-POLICY" "1" "July 2023" "" ""
.
.SH "NAME"
\fBpodsec\-inotify\-check\-policy\fR \- Плугин проверяет образы на предмет их соответствия настройки политикам контейнеризации на узле
.
.SH "SYNOPSIS"
\fBpodsec\-inotify\-check\-images [\-v[vv]] [\-a интервал] [\-f интервал] \-c интервал \-h интервал [\-m интервал] х\-w интервалъ [\-l интервал] [\-d интервал]\fR
.
.SH "DESCRIPTION"
Плугин проверяет образы на предмет их соответствия настройки политикам контейнеризации на узле\. Проверка идет по следующим параметрам:
.
.P
Все веса метрик суммируются и формируется итоговая метрика\.
.
.SH "OPTIONS"
Уровень опасности определяется при запуске флагами:
.
.TP
для системных логов:

.
.IP "" 4
.
.nf


    Имя уровня  | Уровень | Префикс    | Флаг | Рекомендуемое значение интервала
    \-\-\-\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-|\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
    аварийный   |    7    | Crash      | `\-a` | не указывать
    фатальный   |    6    | Fatal      | `\-f` | не указывать
    критический |    5    | Critical   | `\-c` | 100
    высокий     |    4    | Heigh      | `\-h` | 0
    средний     |    3    | Middle     | `\-m` | не указывать
    низкий      |    2    | Low        | `\-l` | не указывать
    отладочный  |    1    | Debug      | `\-d` | не указывать
.
.fi
.
.IP "" 0
.
.TP
для сервера \fBnagios\fR:

.
.IP "" 4
.
.nf


    Имя уровня     | Уровень | Префикс    | Флаг | Рекомендуемое значение интервала
    \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-|\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
    критический    |    2    | Critical   | `\-c` | 100
    предупреждение |    1    | Warning    | `\-w` | 0
.
.fi
.
.IP "" 0
.
.P
Любой параметр может отсутствовать\. В этом случае он не рассматривается при просмотре соответствия полученной метрики интервалам\.
.
.P
Значение параметров имеют формат интервала, описанного в документации по nagios: Threshold and Ranges \fIhttps://nagios\-plugins\.org/doc/guidelines\.html#THRESHOLDFORMAT\fR\.
.
.P
Общее описание:
.
.P
\fB[@]start:end\fR
.
.P
Замечания:
.
.IP "\(bu" 4
\fBstart\fR ≤ \fBend\fR
.
.IP "\(bu" 4
\fBstart\fR и \fB:\fR не требуется если \fBstart=0\fR
.
.IP "\(bu" 4
если интервал задан в формате \fBstart:\fR и конец не задан, то концом интервала считается бесконечность \fBꝏ\fR
.
.IP "\(bu" 4
для указания отрицательной бесконечности (\fB\-ꝏ\fR) используйте \fB~\fR
.
.IP "\(bu" 4
триггер срабатывает когда значение метрики \fBВНЕ УКАЗАННОГО ИНТЕРВАЛА\fR (\fBначальные и конечные точки включаются в интервал\fR)
.
.IP "\(bu" 4
если интервал начинается с символа \fB@\fR, тогда условие инвертируется \- триггер срабатывает при значении метрики \fBВ УКАЗАННОМ ИНТЕРВАЛЕ\fR (начальные и конечные точки включаются в интервал)
.
.IP "" 0
.
.P
Примеры возможных форматов:
.
.IP "" 4
.
.nf


Формат интервала | Описание условия срабатывания триггера
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
100              | metrica < 0 || metrica > 100 (вне интервала 0\-100)
100:             | metrica < 100 (вне интервала 100\-ꝏ)
~:100            | metrica > 100 (вне интервала \-ꝏ\-100)
20\-100           | metrica < 20 || metrica > 100 (вне интервала 20\-100)
@20\-100          | metrica >= 20 && metrica <= 100 (в интервале 20\-100)
.
.fi
.
.IP "" 0
.
.SS "Системные логи"
Для системных логов уровень опасности определяется для каждого сообщения\. Интервалы уровней опасностей, заданные параметрами просматриваются в порядке от большого к меньшему\. Уровень сообщения определяется по первому найденному соответствию (не забываете, что триггер срабатывает при нахождении метрики ВНЕ интервала)\. Если соответствие не найдено, сообщение в системный лог не выводится\.
.
.P
Исходя найденного уровня определяет приоритет сообщения и его тег (префикс)\. В системный лог командой logger посылается сообщение с указанным приоритетом и тегом:
.
.IP "" 4
.
.nf


# logger \-p приоритет \-t тег "тег: сообщение"
.
.fi
.
.IP "" 0
.
.P
Кроме основного сообщения для \fBnagios\fR формируются:
.
.IP "\(bu" 4
список пользователей нарушителей;
.
.IP "\(bu" 4
укороченные сообщения для уровня детализации \fB1\fR\.
.
.IP "" 0
.
.SS "Логи nagios"
Форматы сообщений и кодов завершения плугина описаны в Plugin Output for Nagios \fIhttps://nagios\-plugins\.org/doc/guidelines\.html#PLUGOUTPUT\fR\.
.
.P
Уровень опасности для логов nagios определяется СУММАРНОЙ метрике\. Суммарная метрика определяется для определения уровня сравнивается с интервалами, задаваемыми флагами
.
.IP "\(bu" 4
\fB\-c\fR \- \fBCritical\fR
.
.IP "\(bu" 4
\fB\-w\fR \- \fBWarning\fR
.
.IP "" 0
.
.P
Если соответствие не найдено, в \fBnagios\fR выводится сообщение:
.
.IP "" 4
.
.nf


POLICY OK: Политики контейнеризации не нарушены
.
.fi
.
.IP "" 0
.
.P
Код завершение программы (которое обрабатывается на стороне сервера \fBnagios\fR) \- \fB0\fR\.
.
.P
Формат логов для \fBnagios\fR зависит от уровня детализации, задаваемый флагом \fB\-v[vv]\fR (см\. Verbose Output \fIhttps://nagios\-plugins\.org/doc/guidelines\.html#AEN41\fR):
.
.IP "" 4
.
.nf


Флаг        | Уровень
\-\-\-\-\-\-\-\-\-\-\-\-|\-\-\-\-\-\-\-\-
отcутствует | 0
\-v          | 1
\-vv         | 2
\-vvv        | 3
\.\.\.         | 3
.
.fi
.
.IP "" 0
.
.P
Для всех уровней формируется префикс сообщение формата:
.
.IP "" 4
.
.nf


POLICY $prefix:
.
.fi
.
.IP "" 0
.
.P
Где \fBprefix\fR в зависимости от уровня опасности принимает значения:
.
.IP "\(bu" 4
\fB\-c\fR \- \fBCritical\fR
.
.IP "\(bu" 4
\fB\-w\fR \- \fBWarning\fR
.
.IP "" 0
.
.P
Если уровень детализации \- \fB0\fR, то выводится укороченное сообщение\.
.
.IP "" 4
.
.nf


POLICY $prefix: Нарушение политик контейнеризации пользователей \fIusers\fR
.
.fi
.
.IP "" 0
.
.P
Где \fBusers\fR \- список пользователей у которых обнаружены нарушения\.
.
.P
Если уровень детализации \- \fB1\fR, то к сообщению с префиксом \fIЕсть пользователи:\fR добавляется первый уровень детализации из списка укороченных сообщений сформированных при формировании системных логов\.
.
.IP "" 4
.
.nf


POLICY $prefix: Нарушение политик контейнеризации пользователей $users | Есть пользователи:
укороченное сообщение
\.\.\.
.
.fi
.
.IP "" 0
.
.P
Если уровень детализации \- \fB2\fR, то к сообщению добавляется второй уровень детализации из списка полных сообщений сформированных при формировании системных логов\.
.
.IP "" 4
.
.nf


POLICY $prefix: Нарушение политик контейнеризации пользователей $users | Есть пользователи:
укороченное сообщение
\.\.\.
укороченное сообщение |
полное сообщение
\.\.\.
.
.fi
.
.IP "" 0
.
.P
После вывода сообщений плугин завершается кодом завершения:
.
.IP "\(bu" 4
\fBCritical\fR \- \fB2\fR
.
.IP "\(bu" 4
\fBWarning\fR \- \fB1\fR
.
.IP "" 0
.
.IP "\(bu" 4
создайте в \fB/etc/nagios/commands/\fR конфигурационный файл \fBnagios\-plugins\-podsec\.cfg\fR для всех podsec планинов
.
.IP "" 0
.
.IP "" 4
.
.nf


define command{
        command_name    podsec\-inotify\-check\-policy
        command_line    $USER1$/check_by_ssh \-H $HOSTADDRESS$ \-l root \-C \'/usr/lib/nagios/plugins/podsec\-inotify\-check\-policy \-vvv \-w $ARG1$ \-l $ARG1$ \-c $ARG2$ \'
        }
\.\.\.
.
.fi
.
.IP "" 0
.
.P
В \fBcommand_name\fR надо указать имя плагина которое будет использоваться в секции \fBdefine service\fR файла конфигурации в каталоге \fB/etc/nagios/objects\fR\. В \fBcommand_line\fR не забудьте если в этом есть необходимость указать флаг \fB\-l root\fR для запуска скрипта под пользователем root на удаленной машине\. Если для плагина достаточно прав обыкновенного пользователя \fBnagios\fR, флаг \fB\-l\fR не нужен\.
.
.P
Переменныe \fB$ARG1\fR, \fB$ARG2\fR, \.\.\. берутся из командной строки описания сервиса в каталоге \fB/etc/nagios/objects\fR\.
.
.IP "" 4
.
.nf


define service {
        use generic\-service
        host_name       <host>
        service_description     Check containers policy
        check_command podsec\-inotify\-check\-policy!0!100
        }
.
.fi
.
.IP "" 0
.
.P
В строке \fBservice_description\fR укахите иям сервиска которое будет отображаться в WEB\-интерейсе nagios\. В \fBcheck_command\fR имя команды, из вышеописанного файла \fBnagios\-plugins\-podsec\.cfg\fR каталога \fB/etc/nagios/commands/\fR\. Параметры использумые в команде указываются через символ \fB|\fR\.
.
.SS "Запуск сервиса через systemd/Timers"
Кроме запуска скрипта через \fBnagios\fR скрипт может запускаться через \fBsystemd/Timers\fR\. В состав пакета входит systemd\-файлы \fBpodsec\-inotify\-check\-images\.service\fR, \fBpodsec\-inotify\-check\-images\.timer\fR\. Файл сервисов \fBpodsec\-inotify\-check\-images\.service\fR описывает в параметре \fBExecStart\fR строку с описанием режима запуска скрипта \fBpodsec\-inotify\-check\-images\fR\. Скрипт запускается с флагами \fB\-vvv \-c 100\fR \- выводить подробную информацию, все сообщения имеют уровень \fBc\fR \- критический\. Если во время работы скрипта обнаружены некорректные настройки политики, они выводятся в системный лог и передаются почтой системному администратору (\fBroot\fR)\.
.
.P
Расписание запуска сервиса \fBpodsec\-inotify\-check\-images\.service\fR описывается в параметре \fBOnCalendar\fR файла расписания \fBpodsec\-inotify\-check\-images\.timer\fR\. Сервис вызывается ежечасно\.
.
.P
По умолчанию таймер запуска сервиса выключен\. Для его включения наберите команду:
.
.IP "" 4
.
.nf


#  systemctl enable \-\-now podsec\-inotify\-check\-images\.timer
.
.fi
.
.IP "" 0
.
.P
Если необходимо изменить режим запуска скрипта отредактируйте параметр \fBOnCalendar\fR файла расписания \fBpodsec\-inotify\-check\-images\.timer\fR\.
.
.SH "EXAMPLES"
\fBpodsec\-inotify\-check\-images \-vvv \-w 0 \-h 0 \-c 100\fR
.
.SH "SECURITY CONSIDERATIONS"
.
.SH "SEE ALSO"
.
.SH "AUTHOR"
Костарев Алексей, Базальт СПО kaf@basealt\.ru
