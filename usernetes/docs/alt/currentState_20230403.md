# Текущее состояние на 3.04.2023

На период с 30.04.2023 до 3.04.2023 были проделаны следующие работы:

- развернуты варианты портирования usernetes под ALTLinux p10;
- с целью ускорения разработки и тестирования реализован вариант разворачивания в docker-окружении;

## Особенности разворачивания kubernetes в варианте usernetes по отношении к стандартному

В **стандартном решении** для разворачивания кластера используется `kubernetes-команда `kubeadm`.
`kubeadm` "заточена" под `rootfull`-окружении поэтому без модификации кода применить ее для разворачивания `rootless` невозможно.

При **разворачивани в стандартном решении** основные сервисы `kubernetes`:

- `kube-proxy`;
- `kube-apiserver`;
- `kube-scheduler`;
- `etcd`;
- `kube-controller-manager`;
- `coredns`.

запускаются `kubeadm` как crio-контейнеры.

В стандартном решении они видны как:

- `daemonset.apps/kube-proxy`;
- `pod/kube-apiserver-host-<hostname>`;
- `pod/kube-scheduler-host-<hostname>`;
- `pod/etcd-host-<hostname>`;
- `pod/kube-controller-manager-host-<hostname>`;

В **варианте `usernetes`** эти сервисы разорачиваются как `systemd-сервисы`и kubernetes в варианте `usernetes` используются **системные сервисы**.

Разворачивание в зависимости от типа узла производится в двух вариантах:
- master-узла - цель `u7s-master-with-etcd.target`;
- worker-узла - цель `Различия master и worker's на u7s`.

Для master-узла сервисы `u7s-kubelet-crio.service`, `u7s-kube-proxy.service`, `u7s-flanneld.service` не разорачиваются.
Поэтому master-узел в списке узлов не отображается.
Для добавление master-узла необходимо модифицировать зависимости сервисов для того, чтобы сервисы `u7s-kubelet-crio.service`, `u7s-kube-proxy.service`, `u7s-flanneld.service` разворачивались и для master-узла (не проверялось).
Будет ли master-узел работать с режиме отказа от запуска обычных Pod'ов (наличие меток 'Taints:') необходимо проверить.
Единственный запускаемый `kubernetes`-сервис:

- `deployment.apps/coredns`.

## Достоинства решений usernetes

- Все окружение, поддерживающее вариант разворачивания kubernetes в режиме usernetes работает в rootless-окружении
- Запускаемые Pod'ы (контейнеры) работают в rootless окружении.

## Текущие проблемы

- При разворачивании в режиме `docker` при запуске образа в терминальном режиме (`kubectl run -it`) или захода в контейнер (`kubectl exec -it`) происходит завершение
по причине нехватке прав на устройство `/dev/ptmx`. В режиме запуска в режиме `baremetal` или `libvirt` этой проблемы не наблюдается.

- Для генерации сертификатов используется программа `cfssl` отсутствующая в репозитории ALT Sisyphis. Можно либо включить ее в состав репозитория, либо заменить в скрипте генерации сертификата `cfssl` на `openssl`. Смотри [Generate Certificates Manually](https://kubernetes.io/docs/tasks/administer-cluster/certificates/).

- В стандартном решении при разворачивании кластера в нем разворачивается набор кластерных ролей (смотри [Описание основных классов ролей кластера (Roles, ClusterRoles) и механизмов из связываения с субъектами](https://github.com/alt-cloud/podsec/blob/github/k8s/RBAC/addUser/rolesDescribe.md)). При разворачивании в режиме `usernetes` в kubernetes-кластере заводится единственная роль из списка кластерных ролей: `system:coredns`. Недостающие роли довольно просто экспортировать.

- После генерации сертификата и файла конфигурации для пользователя (смотри [Создание рабочих мест и сертификатов](https://github.com/alt-cloud/podsec/blob/github/k8s/RBAC/addUser/create-user.md)) пользователь без привязки ролей получает права администратора. Возможно это связано с тем, что не проходит авторизация пользователя, возможно к нему по умолчанию привязывается роль администратора. С этим надо разбираться. **Это наиболее серъезная проблема на текущий момент.**
