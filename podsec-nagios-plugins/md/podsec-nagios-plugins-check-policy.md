podsec-nagios-plugins-check-policy(1) -- Плугин проверяет политики настройки контейнеризации на узле
================================

## SYNOPSIS

`podsec-nagios-plugins-check-policy -w уровни_реагирования -c  уровни_реагирования`

## DESCRIPTION

### Общее описание

Плугин проверяет политики настройки контейнеризации на узле.

Проверка идет по следующим параметрам:

<pre>
    Параметр контроля                                                                                                         | Вес метрики
    --------------------------------------------------------------------------------------------------------------------------|------------- 
    имеющих `defaultPolicy != reject`, но не входящих в группу `podman_dev`                                                   | 102
    не имеющих не имеющих `registry.local` в списке регистраторов для которых проверяется наличие электронной подписи образов | 103
    имеющих в политике регистраторы для которых не проверяется наличие электронной подписи образов                            | 104
    имеющих в списке поддерживаемых транспорты отличные от `docker` (транспорт получения образов с регистратора)              | 105
</pre>

- файлы привязки регистраторов к серверам хранящим электронные подписи (файл привязки о умолчанию `default.yaml` и файлы привязки регистраторов `*.yaml` каталога `registries.d`). Наличие (число) пользователей:
<pre>
    Параметр контроля                                                                                            | Вес метрики
    -------------------------------------------------------------------------------------------------------------|-------------
    не использующих хранилище подписей  `http://sigstore.local:81/sigstore/` как хранилище подписей по умолчанию | 106
</pre>

- контроль групп пользователей

    * наличие пользователей имеющих образы, но не входящих в группу `podman`:
<pre>
        Параметр контроля                                                      | Вес метрики
        -----------------------------------------------------------------------|-------------
        наличие пользователей имеющих образы, но не входящих в группу `podman` | 101
</pre>

    * наличие пользователей группы `podman` (за исключением входящих в группу `podman_dev`):
<pre>
        Параметр контроля | Вес метрики
        ---------------------------------------------------------------------|-------------
        входящих в группу `wheel`                                            | 107
        имеющих каталог `.config/containers/` открытым на запись и изменения | 90 * `доля_нарушителей`
        не имеющих файла конфигурации `.config/containers/storage.conf`      | 90 * `доля_нарушителей
</pre>

`доля_нарушителей` считается как: `число_нарушителей / число_пользователей_группы_podman`

Все веса метрик суммируются и формируется итоговая метрика.


## OPTIONS

Уровень опасности определяется при запуске флагами:

- для системных логов:
<pre>
    Имя уровня  | Уровень | Префикс    | Флаг | Рекомендуемое значение интервала
    ------------|---------|------------|------|------------------------
    аварийный   |    7    | Crash      | `-a` | 10000
    фатальный   |    6    | Fatal      | `-f` | 1000
    критический |    5    | Critical   | `-c` | 100 
    высокий     |    4    | Heigh      | `-h` | 80
    средний     |    3    | Middle     | `-m` | 40
    низкий      |    2    | Low        | `-l` | 20
    отладочный  |    1    | Debug      | `-d` | 10
</pre>

- для сервера `nagios`:
<pre>
    Имя уровня     | Уровень | Префикс    | Флаг | Рекомендуемое значение интервала
    ---------------|---------|------------|------|-----------------------
    критический    |    2    | Critical   | `-c` | 100
    предупреждение |    1    | Warning    | `-w` | 0
</pre>

Любой параметр может отсутствовать. В этом случае он не рассматривается при просмотре соответствия полученной метрики интервалам.

Значение параметров имеют формат интервала, описанного в документации по nagios: [Threshold and Ranges](https://nagios-plugins.org/doc/guidelines.html#THRESHOLDFORMAT).

Общее описание:

`[@]start:end`

Замечание:

* `start` ≤ `end`
* `start` и `:` не требуется если `start=0`
* если интервал задан в формате `start:` и конец не задан, то концом интервала считается бесконечность `ꝏ`
* для указания отрицательной бесконечности (`-ꝏ`) используйте `~`
* триггер срабатывает когда значение метрики **ВНЕ УКАЗАННОГО ИНТЕРВАЛА** (**начальные и конечные точки включаются в интервал**)
* если интервал начинается с символа `@`, тогда условие инвертируется - триггер срабатывает при значении метрики **В УКАЗАННОМ ИНТЕРВАЛЕ** (начальные и конечные точки включаются в интервал)

Примеры возможных форматов:
<pre>
Формат интервала | Описание условия срабатывания триггера
-----------------|--------------------------------------
100              | metrica &lt; 0 || metrica &gt; 100 (вне интервала 0-100)
100:             | metrica &lt; 100 (вне интервала 100-ꝏ)
~:100            | metrica &gt; 100 (вне интервала -ꝏ-100)
20-100           | metrica &lt; 20 || metrica &gt; 100 (вне интервала 20-100)
@20-100          | metrica &gt;= 20 && metrica &lt;= 100 (в интервале 20-100)
</pre>


### Системные логи

Для системных логов  уровень опасности определяется для каждого сообщения.
Интервалы уровней опасностей, заданные параметрами просматриваются в порядке от большого к меньшему.
Уровень сообщения определяется по первому найденному соответствию (не  забываете, что триггер срабатывает при нахождении метрики ВНЕ интервала). 
Если соответствие не найдено, сообщение в системный лог не выводится.

Исходя найденного уровня определяет приоритет сообщения и его тег (префикс).
В системный лог командой logger посылается сообщение с указанным приоритетом и  тегом:  
<pre> 
# logger -p приоритет -t тег "тег: сообщение" 
</pre>

Кроме основного сообщения для `nagios` формируются:

- список пользователей нарушителей;
- укороченные сообщения для уровня детализации `1`.


### Логи nagios

Форматы сообщений и кодов завершения плугина описаны в [Plugin Output for Nagios](https://nagios-plugins.org/doc/guidelines.html#PLUGOUTPUT).

Уровень опасности для логов nagios определяется СУММАРНОЙ метрике.
Суммарная метрика определяется для определения уровня сравнивается с интервалами, задаваемыми флагами

* `-c` - `Critical`
* `-w` - `Warning`

Если соответствие не найдено, в `nagios` выводится сообщение:
<pre>
POLICY OK: Политики контейнеризации не нарушены
</pre>
Код завершение программы (которое обрабатывается на стороне сервера `nagios`) - `0`.

Формат логов для `nagios` зависит от уровня детализации,  задаваемый флагом `-v[vv]` (см. [Verbose Output](https://nagios-plugins.org/doc/guidelines.html#AEN41)):
<pre>
Флаг        | Уровень
------------|--------
отcутствует | 0
-v          | 1
-vv         | 2
-vvv        | 3
...         | 3
</pre>

Для всех уровней формируется префикс сообщение формата:
<pre>
POLICY $prefix: 
</pre>
Где `prefix` в зависимости от уровня опасности принимает значения:

- `-c` - `Critical`
- `-w` - `Warning`

Если уровень детализации - `0`, то выводится укороченное сообщение.
<pre>
POLICY $prefix: Нарушение политик контейнеризации пользователей <users>
</pre>
Где `users` -  список пользователей у которых обнаружены нарушения.  
  
Если уровень детализации - `1`, то к сообщению с префиксом *Есть пользователи:* добавляется первый уровень детализации из списка укороченных сообщений сформированных при формировании системных логов.
<pre>
POLICY $prefix: Нарушение политик контейнеризации пользователей $users | Есть пользователи:
укороченное сообщение
...
</pre>

Если уровень детализации - `2`, то к сообщению добавляется второй уровень детализации из списка полных сообщений сформированных при формировании системных логов.
<pre>
POLICY $prefix: Нарушение политик контейнеризации пользователей $users | Есть пользователи:
укороченное сообщение
...
укороченное сообщение |
полное сообщение
...
</pre>

После вывода сообщений плугин завершается кодом завершения:

- `Critical` - `2`
- `Warning` - `1`



## EXAMPLES

Проанализировать политики политики с максимальным уровнем детализации.
Критический уровень (`nagios`, `system`) `>100`. Уровень предупреждений (`nagios`) `>0`. Низкий уровень (`system`) `>0`.
<pre>
# ./podsec-nagios-plugins-check-policy -vvv  -w 0 -l 0 -c 100  
POLICY Critical(18): Нарушение политик контейнеризации пользователей  "imagedeveloper" "k8s-user1" "kaf" "kafpodman" "podmanuser" "root" "securityadmin" "user" "user1"  | Есть пользователи:
вне группы podman,
способные получать любой образ
способные получать локальный образ без подписи
способные получать любой образ без подписи
способные получать любой образ через запрещенный транспорт
не использующие локальный хранитель подписей
входящие в группу wheel
не имеющих конфигурационного файла
способные изменить конфигурацию" | 
Critical(101): Пользователи "kafpodman"  имеют образы, но не входят в группу 'podman'
Critical(102): Пользователи "user"  имеют в policy.json defaultPolicy!=reject, но не входят в группу 'podman_dev'
Critical(103): Пользователи "user"  не имеют registry.local в списке регистраторов для которых проверяется наличие электронной подписи образов
Critical(104): Пользователи "root" "kaf" "kafpodman" "podmanuser" "securityadmin" "user1"  имеют в политике регистраторы для которых не проверяется наличие электронной подписи образов
Critical(105): Пользователи "user"  имеют в списке поддерживаемых транспорты отличные от docker
Critical(106): Пользователи "imagedeveloper" "user"  не используют хранилище подписей  http://sigstore.local:81/sigstore/ как хранилище подписей по умолчанию
Critical(107): Пользователи  "kaf" "securityadmin" входят в группы 'podman' и 'wheel'
Low(72): Пользователи  "k8s-user1" "kaf" "securityadmin" "user1" не имеют конфигурационного файла .config/containers/storage.conf
Low(18): Пользователи  "user" имеют открытым для записи каталог конфигурации .config/containers

</pre>


## SECURITY CONSIDERATIONS

## SEE ALSO

- [Nagios Plugins. Development Guidelines](https://nagios-plugins.org/doc/guidelines.html#PLUGOUTPUT)

## AUTHOR

Костарев Алексей, Базальт СПО
kaf@basealt.ru
